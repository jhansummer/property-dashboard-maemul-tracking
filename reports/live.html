<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>매물 트래킹 대시보드</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --muted:#7f8ea3; --text:#e8eef7;
      --line:#24314a; --pill:#1a2640; --pillOn:#2a3a5f;
      --good:#66e3a6; --bad:#ff7b7b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    html, body { max-width:100%; overflow-x:hidden; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1400px;margin:0 auto;padding:14px;overflow-x:hidden}

    .topbar{position:sticky;top:0;z-index:50;background:rgba(11,15,23,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .topbar .wrap{padding:10px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-size:16px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:var(--pill);border:1px solid var(--line);color:var(--text);padding:7px 12px;border-radius:999px;font-size:12px;cursor:pointer;user-select:none}
    .pill.on{background:var(--pillOn);border-color:#3a4a70;font-weight:bold}
    .badge{font-size:11px;color:#cfe0ff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#0f1626}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
    .card h2{margin:0 0 10px 0;font-size:15px;color:#fff}
    .hint{font-size:12px;color:var(--muted);margin-bottom:10px}

    .tableWrap{
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--line);
      background:#0f1626;
      max-width:100%;
      -webkit-overflow-scrolling: touch;
    }

    table{
      border-collapse:separate;border-spacing:0;
      width:100%;
      min-width:980px;
    }

    thead th{
      position:sticky;top:0;background:#1a2640;color:#cfe0ff;font-size:12px;
      text-align:left;border-bottom:1px solid var(--line);padding:10px;white-space:nowrap
    }
    tbody td{padding:10px;border-bottom:1px solid rgba(36,49,74,.55);font-size:12px;color:var(--text);white-space:nowrap}
    tbody tr:hover td{background:rgba(138,180,255,.06)}
    .num{text-align:right;font-variant-numeric:tabular-nums}
    .pct.good{color:var(--good);font-weight:700}
    .pct.bad{color:var(--bad);font-weight:700}
    .mini{font-size:11px;color:var(--muted);margin-top:8px}
    .loading-row td{text-align:center;padding:40px;color:var(--muted)}
    .warn{margin-top:10px;padding:10px;border:1px solid rgba(255,209,102,.35);background:rgba(255,209,102,.08);border-radius:12px;color:var(--warn);font-size:12px;white-space:pre-wrap}

    select{
      background:#0f1626;border:1px solid var(--line);color:var(--text);
      padding:10px 10px;border-radius:12px;outline:none;font-size:13px
    }

    /* charts */
    .chartGrid{ display:grid; grid-template-columns:1fr; gap:12px; }
    .chartBox{
      border:1px solid var(--line);
      background:#0f1626;
      border-radius:12px;
      padding:10px;
      overflow:hidden;
    }
    .chartMeta{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px; }
    .chartTitle{ font-size:12px; color:#cfe0ff; font-weight:700; }
    img.chart{ display:block; width:100%; height:auto; border-radius:10px; }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div>
          <div class="title">매물 트래킹 대시보드(오늘과 지난주 같은요일 비교)</div>
          <div class="sub" id="subtitle">데이터를 불러오는 중...</div>
        </div>
        <div class="spacer"></div>
        <div class="pills" aria-label="trade type">
          <div class="pill on" id="pillA1">매매</div>
          <div class="pill" id="pillB1">전세</div>
        </div>
        <span class="badge" id="dataMTime">데이터 수정 : -</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    
    <div class="card">
      <h2>0) 그래프</h2>
      <div class="hint">• 상단 토글(매매/전세)에 따라 그래프가 자동 변경됩니다.</div>

      <div class="chartGrid">
        <div class="chartBox">
          <div class="chartMeta">
            <span class="chartTitle">전체 매물수 추이</span>
            <span class="badge" id="badge_cnt">image: -</span>
          </div>
          <img class="chart" id="img_cnt" alt="전체 매물수 추이 그래프" loading="lazy" />
          <div class="warn" id="warn_img_cnt" style="display:none"></div>
        </div>

        <div class="chartBox">
          <div class="chartMeta">
            <span class="chartTitle">평균가 추이</span>
            <span class="badge" id="badge_avg">image: -</span>
          </div>
          <img class="chart" id="img_avg" alt="평균가 추이 그래프" loading="lazy" />
          <div class="warn" id="warn_img_avg" style="display:none"></div>
        </div>
      </div>

      <div class="mini" id="chart_hint">
        ※ 그래프가 안 보이면: reports/charts/에 png가 실제로 있는지 + 경로가 맞는지 확인
      </div>
    </div>

    <div class="card">
      <h2>1) 전체 통계</h2>
      <div class="hint">• 면적 구간별 통합 데이터 (소형(33㎡ 미만), 대형(165㎡ 초과) 제외)</div>
      <div class="tableWrap">
        <table>
          <thead><tr id="thead_all"></tr></thead>
          <tbody id="tbody_all"></tbody>
        </table>
      </div>
      <div class="mini" id="meta_all"></div>
      <span class="badge" id="cnt_all">rows: -</span>
      <div class="warn" id="warn_all" style="display:none"></div>
    </div>

    <div class="card">
      <h2>2) 지역별 상세</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <select id="r2_1"><option value="">서울/경기(전체)</option></select>
        <select id="r2_2"><option value="">시·구(전체)</option></select>
        <select id="r2_3"><option value="">세부구(전체)</option></select>
        <span class="badge" id="badge_region">filter: *</span>
      </div>
      <div class="hint">• 지역 및 면적 구간별 데이터 (소형(33㎡ 미만), 대형(165㎡ 초과) 제외)</div>
      <div class="tableWrap">
        <table>
          <thead><tr id="thead_region"></tr></thead>
          <tbody id="tbody_region"></tbody>
        </table>
      </div>
      <div class="mini" id="meta_region"></div>
      <span class="badge" id="cnt_region">rows: -</span>
      <div class="warn" id="warn_region" style="display:none"></div>
    </div>

    <div class="card">
      <h2>3) 단지별 상세</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px">
        <select id="r3_1"><option value="">서울/경기(전체)</option></select>
        <select id="r3_2"><option value="">시·구(전체)</option></select>
        <select id="r3_3"><option value="">세부구(전체)</option></select>
        <select id="r3_c"><option value="">단지(전체)</option></select>
        <span class="badge" id="badge_complex">filter: *</span>
      </div>
      <div class="hint">• 단지별 + 전용면적(spc_bin) 기준 상세 데이터 (소형(33㎡ 미만), 대형(165㎡ 초과) 제외)</div>
      <div class="tableWrap">
        <table>
          <thead><tr id="thead_complex"></tr></thead>
          <tbody id="tbody_complex"></tbody>
        </table>
      </div>
      <div class="mini" id="meta_complex"></div>
      <span class="badge" id="cnt_complex">rows: -</span>
      <div class="warn" id="warn_complex" style="display:none"></div>
    </div>

  </div>

<script>
  const COL_LABELS = {
    level: "구분",
    group: "집계",
    hscpNo: "단지ID",
    complex_name: "단지명",
    region1: "광역",
    region2: "시·구",
    region3: "세부지역",
    spc_bin: "전용면적",
    prev_cnt: "이전 매물수",
    prev_avg_eok: "이전 평균가(억)",
    curr_cnt: "현재 매물수",
    curr_avg_eok: "현재 평균가(억)",
    avg_change_pct: "평균가 변화율",
    new_cnt: "신규 매물수",
    new_avg_eok: "신규 평균가(억)",
    new_premium_pct: "신규매물가(평균대비%)",
    del_cnt: "삭제 매물수",
    del_avg_eok: "삭제 평균가(억)",
    del_premium_pct: "삭제매물가(평균대비%)"
  };

  const HIDE_COLS = {
    all:    new Set(["level", "group"]),
    region: new Set(["level"]),
    // ✅ 단지별은 전용면적(spc_bin) 포함해서 보여주되, 구분/단지ID만 숨김
    complex:new Set(["level", "hscpNo"]),
  };

  const VIEW_COLS = { all:[], region:[], complex:[] };

  function setSubtitle(msg){
    const el = document.getElementById("subtitle");
    if (el) el.textContent = msg;
  }
  window.onerror = function(message, source, lineno, colno){
    setSubtitle(`JS 오류: ${message} @${lineno}:${colno}`);
  };
  window.onunhandledrejection = function(ev){
    const m = (ev && ev.reason) ? (ev.reason.message || String(ev.reason)) : "unknown";
    setSubtitle(`Promise 오류: ${m}`);
  };

  // ✅ 후보 경로를 여러 개 두고 "실제로 존재하는 것"을 자동 선택
  const CANDIDATES = {
    A1: {
      all:    ["./reports/report_all_bins_A1_latest.csv", "./report_all_bins_A1_latest.csv"],
      region: ["./reports/report_region_bins_A1_latest.csv", "./report_region_bins_A1_latest.csv"],
      complex:["./reports/report_complex_bins_A1_latest.csv", "./report_complex_bins_A1_latest.csv"],
      charts: {
        cnt: ["./reports/charts/all_bins_A1_cnt.png", "./charts/all_bins_A1_cnt.png", "./reports/charts/all_bins_cnt.png"],
        avg: ["./reports/charts/all_bins_A1_avg.png", "./charts/all_bins_A1_avg.png", "./reports/charts/all_bins_avg.png"],
      }
    },
    B1: {
      all:    ["./reports/report_all_bins_B1_latest.csv", "./report_all_bins_B1_latest.csv"],
      region: ["./reports/report_region_bins_B1_latest.csv", "./report_region_bins_B1_latest.csv"],
      complex:["./reports/report_complex_bins_B1_latest.csv", "./report_complex_bins_B1_latest.csv"],
      charts: {
        cnt: ["./reports/charts/all_bins_B1_cnt.png", "./charts/all_bins_B1_cnt.png", "./reports/charts/all_bins_cnt.png"],
        avg: ["./reports/charts/all_bins_B1_avg.png", "./charts/all_bins_B1_avg.png", "./reports/charts/all_bins_avg.png"],
      }
    }
  };

  let state = { type:"A1" };

  async function existsUrl(url){
    try{
      const res = await fetch(url + `?v=${Date.now()}`, { method:"HEAD", cache:"no-store" });
      return res.ok;
    }catch(e){
      return false;
    }
  }

  async function pickFirstExisting(urls){
    for (const u of (urls||[])){
      if (await existsUrl(u)) return u;
    }
    return null;
  }

  function parseCSV(text){
    if (!text) return {cols:[], rows:[], error:"empty response"};
    if (text.charCodeAt(0) === 0xFEFF) text = text.slice(1);

    const rows = [];
    let row = [];
    let cell = "";
    let inQ = false;

    for (let i=0;i<text.length;i++){
      const ch = text[i];

      if (ch === '"'){
        if (inQ && text[i+1] === '"'){ cell += '"'; i++; }
        else inQ = !inQ;
        continue;
      }

      if (!inQ && ch === ','){ row.push(cell); cell=""; continue; }
      if (!inQ && ch === '\n'){ row.push(cell); cell=""; rows.push(row); row=[]; continue; }
      if (ch === '\r') continue;
      cell += ch;
    }
    if (cell.length || row.length){ row.push(cell); rows.push(row); }

    const cleaned = rows.filter(r => r.some(c => String(c).trim().length > 0));
    if (cleaned.length < 2) return {cols:[], rows:[], error:`lines<2 (${cleaned.length})`};

    const cols = cleaned[0].map(s => String(s).trim());
    if (!cols.length || cols.every(c => !c)) return {cols:[], rows:[], error:"header empty"};

    const out = [];
    for (let i=1;i<cleaned.length;i++){
      const parts = cleaned[i];
      const obj = {};
      cols.forEach((c, idx) => obj[c] = (parts[idx] ?? "").toString().trim());
      out.push(obj);
    }
    return {cols, rows: out};
  }

  function toNum(x){
    if (x == null) return null;
    let s = String(x).trim();
    if (!s || s === "-") return null;
    if (s.endsWith('%')) s = s.slice(0, -1);
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : null;
  }
  function pctClass(v){
    if (v == null) return "";
    if (v > 0) return "good";
    if (v < 0) return "bad";
    return "";
  }

  const NUM_COLS = new Set([
    "prev_cnt","curr_cnt","new_cnt","del_cnt",
    "prev_avg_eok","curr_avg_eok","new_avg_eok","del_avg_eok",
    "avg_change_pct","new_premium_pct","del_premium_pct"
  ]);

  function showWarn(sectionId, msg){
    const el = document.getElementById(`warn_${sectionId}`);
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
  }
  function hideWarn(sectionId){
    const el = document.getElementById(`warn_${sectionId}`);
    if (!el) return;
    el.style.display = "none";
    el.textContent = "";
  }

  // ✅ ALL_BINS → "전체"는 1번(all) 표에서만
  function displayCell(sectionId, col, val){
    if (col === "spc_bin"){
      const s = String(val ?? "").trim();
      if (sectionId === "all" && s === "ALL_BINS") return "전체";
      return s;
    }
    return (val ?? "");
  }

  // ✅ spc_bin 행 제외: <33, >=165 (공통)
  function passSpcBinRow(r){
    const b = String(r?.spc_bin ?? "").trim();
    if (b === "<33") return false;
    if (b === ">=165") return false;
    return true;
  }

  function render(sectionId, cols, rows){
    const thead = document.getElementById(`thead_${sectionId}`);
    const tbody = document.getElementById(`tbody_${sectionId}`);
    const meta = document.getElementById(`meta_${sectionId}`);
    const cnt  = document.getElementById(`cnt_${sectionId}`);
    if (!thead || !tbody || !meta || !cnt) return;

    thead.innerHTML = "";
    tbody.innerHTML = "";

    if (!cols || cols.length === 0){
      tbody.innerHTML = "<tr><td colspan='100' style='text-align:center; padding:20px;'>데이터가 없습니다.</td></tr>";
      cnt.textContent = "rows: -";
      meta.textContent = "";
      return;
    }

    cols.forEach(c => {
      const th = document.createElement("th");
      th.textContent = COL_LABELS[c] || c;
      thead.appendChild(th);
    });

    (rows || []).forEach(r => {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const td = document.createElement("td");
        const raw = r[c] ?? "";
        const val = displayCell(sectionId, c, raw);

        if (NUM_COLS.has(c)) td.classList.add("num");
        if (String(val).includes('%')){
          td.classList.add("pct");
          const cls = pctClass(toNum(val));
          if (cls) td.classList.add(cls);
        }

        td.textContent = val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    cnt.textContent = `rows: ${(rows||[]).length}`;
    meta.textContent = `columns(${cols.length}): ${cols.join(", ")}`;
  }

  async function fetchTextWithTimeout(url, ms=10000){
    const controller = new AbortController();
    const t = setTimeout(() => controller.abort(), ms);
    try{
      const res = await fetch(url + `?v=${Date.now()}`, { signal: controller.signal, cache: "no-store" });
      const text = await res.text();
      return { res, text };
    } finally {
      clearTimeout(t);
    }
  }

  async function loadOne(kind){
    const picked = await pickFirstExisting(CANDIDATES[state.type][kind]);
    if (!picked) return {cols:[], rows:[], error: `${kind}: file not found (path candidates all failed)`};

    try {
      const { res, text } = await fetchTextWithTimeout(picked, 10000);
      if (!res.ok) return {cols:[], rows:[], error: `${kind}: HTTP ${res.status} (${picked})`};

      const head = text.slice(0, 80).trim().toLowerCase();
      if (head.startsWith("<!doctype html") || head.startsWith("<html")) {
        return {cols:[], rows:[], error: `${kind}: got HTML not CSV (${picked})`};
      }

      const parsed = parseCSV(text);
      if (!parsed.cols.length){
        return {cols:[], rows:[], error: `${kind}: parse cols=0 (${parsed.error||"unknown"}) (${picked})`};
      }
      parsed.__url = picked;
      return parsed;

    } catch (e) {
      const msg = (e && e.name === "AbortError") ? "timeout(10s)" : (e.message || String(e));
      return {cols:[], rows:[], error: `${kind}: ${msg} (${picked})`};
    }
  }

  async function getLastModified(url){
    try{
      const res = await fetch(url + `?v=${Date.now()}`, { method: "HEAD", cache: "no-store" });
      const lm = res.headers.get("last-modified");
      return lm || null;
    } catch {
      return null;
    }
  }

  function showImgWarn(which, msg){
    const el = document.getElementById(`warn_img_${which}`);
    if (!el) return;
    el.style.display = "block";
    el.textContent = msg;
  }
  function hideImgWarn(which){
    const el = document.getElementById(`warn_img_${which}`);
    if (!el) return;
    el.style.display = "none";
    el.textContent = "";
  }

  async function renderCharts(){
    const imgCnt = document.getElementById("img_cnt");
    const imgAvg = document.getElementById("img_avg");
    const badgeCnt = document.getElementById("badge_cnt");
    const badgeAvg = document.getElementById("badge_avg");
    if (!imgCnt || !imgAvg) return;

    hideImgWarn("cnt");
    hideImgWarn("avg");

    const cntPicked = await pickFirstExisting(CANDIDATES[state.type].charts.cnt);
    const avgPicked = await pickFirstExisting(CANDIDATES[state.type].charts.avg);

    if (!cntPicked){
      imgCnt.removeAttribute("src");
      showImgWarn("cnt", `cnt png 경로를 못 찾음.\n시도: ${CANDIDATES[state.type].charts.cnt.join(" | ")}`);
    } else {
      imgCnt.src = `${cntPicked}?v=${Date.now()}`;
    }

    if (!avgPicked){
      imgAvg.removeAttribute("src");
      showImgWarn("avg", `avg png 경로를 못 찾음.\n시도: ${CANDIDATES[state.type].charts.avg.join(" | ")}`);
    } else {
      imgAvg.src = `${avgPicked}?v=${Date.now()}`;
    }

    if (badgeCnt) badgeCnt.textContent = `단위 : 건수`;
    if (badgeAvg) badgeAvg.textContent = `단위 : 억원`;
  }

  // dropdown helpers
  function uniq(arr){
    return Array.from(new Set((arr||[]).filter(x => x != null && String(x).trim() !== "")))
      .map(x => String(x).trim())
      .sort((a,b)=>a.localeCompare(b,"ko"));
  }
  function setOpts(sel, vals, ph){
    if (!sel) return;
    const cur = (sel.value) ? sel.value : "";
    sel.innerHTML = `<option value="">${ph}</option>`;
    (vals||[]).forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      sel.appendChild(o);
    });
    if (cur && (vals||[]).includes(cur)) sel.value = cur;
  }

  function setDefaultSeoulGangnam(level1Sel, level2Sel){
    if (!level1Sel || !level2Sel) return;
    const hasSeoul = Array.from(level1Sel.options).some(o => o.value === "서울시");
    if (hasSeoul) level1Sel.value = "서울시";
  }

  function initRegionFilters(region){
    const r1 = document.getElementById("r2_1");
    const r2 = document.getElementById("r2_2");
    const r3 = document.getElementById("r2_3");
    const badge = document.getElementById("badge_region");
    if (!r1 || !r2 || !r3 || !region || !region.rows) return;

    const baseRows = (region.rows || []).filter(passSpcBinRow);

    setOpts(r1, uniq(baseRows.map(r=>r.region1)), "서울/경기(전체)");
    setDefaultSeoulGangnam(r1, r2);

    const refreshR2 = ()=>{
      const rows1 = r1.value ? baseRows.filter(r => String(r.region1||"").trim() === r1.value) : baseRows;
      setOpts(r2, uniq(rows1.map(r=>r.region2)), "시·구(전체)");
      setOpts(r3, [], "세부구(전체)");

      if (r1.value === "서울시") {
        const hasGangnam = Array.from(r2.options).some(o => o.value === "강남구");
        if (hasGangnam) r2.value = "강남구";
      }
    };

    const refreshR3 = ()=>{
      let rows2 = baseRows.slice();
      if (r1.value) rows2 = rows2.filter(r => String(r.region1||"").trim() === r1.value);
      if (r2.value) rows2 = rows2.filter(r => String(r.region2||"").trim() === r2.value);
      setOpts(r3, uniq(rows2.map(r=>r.region3)), "세부구(전체)");
    };

    const apply = ()=>{
      let rows = baseRows.slice();
      if (r1.value) rows = rows.filter(r => String(r.region1||"").trim() === r1.value);
      if (r2.value) rows = rows.filter(r => String(r.region2||"").trim() === r2.value);
      if (r3.value) rows = rows.filter(r => String(r.region3||"").trim() === r3.value);

      render("region", VIEW_COLS.region, rows);

      if (badge) badge.textContent =
        `filter: ${[r1.value,r2.value,r3.value].filter(Boolean).join(" / ") || "*"}`;
    };

    r1.onchange = ()=>{ refreshR2(); r3.value=""; apply(); };
    r2.onchange = ()=>{ refreshR3(); apply(); };
    r3.onchange = apply;

    refreshR2();
    refreshR3();
    apply();
  }

  function initComplexFilters(complex){
    const r1 = document.getElementById("r3_1");
    const r2 = document.getElementById("r3_2");
    const r3 = document.getElementById("r3_3");
    const rc = document.getElementById("r3_c");
    const badge = document.getElementById("badge_complex");
    if (!r1 || !r2 || !r3 || !rc || !complex || !complex.rows) return;

    const baseRows = (complex.rows || []).filter(passSpcBinRow);

    setOpts(r1, uniq(baseRows.map(r=>r.region1)), "서울/경기(전체)");
    setDefaultSeoulGangnam(r1, r2);

    const refreshR2 = ()=>{
      const rows1 = r1.value ? baseRows.filter(r => String(r.region1||"").trim() === r1.value) : baseRows;
      setOpts(r2, uniq(rows1.map(r=>r.region2)), "시·구(전체)");
      setOpts(r3, [], "세부구(전체)");
      setOpts(rc, [], "단지(전체)");

      if (r1.value === "서울시") {
        const hasGangnam = Array.from(r2.options).some(o => o.value === "강남구");
        if (hasGangnam) r2.value = "강남구";
      }
    };

    const refreshR3 = ()=>{
      let rows2 = baseRows.slice();
      if (r1.value) rows2 = rows2.filter(r => String(r.region1||"").trim() === r1.value);
      if (r2.value) rows2 = rows2.filter(r => String(r.region2||"").trim() === r2.value);
      setOpts(r3, uniq(rows2.map(r=>r.region3)), "세부구(전체)");
      setOpts(rc, [], "단지(전체)");
    };

    const refreshComplex = ()=>{
      let rows3 = baseRows.slice();
      if (r1.value) rows3 = rows3.filter(r => String(r.region1||"").trim() === r1.value);
      if (r2.value) rows3 = rows3.filter(r => String(r.region2||"").trim() === r2.value);
      if (r3.value) rows3 = rows3.filter(r => String(r.region3||"").trim() === r3.value);

      setOpts(rc, uniq(rows3.map(r=>r.complex_name)), "단지(전체)");
    };

    const apply = ()=>{
      let rows = baseRows.slice();
      if (r1.value) rows = rows.filter(r => String(r.region1||"").trim() === r1.value);
      if (r2.value) rows = rows.filter(r => String(r.region2||"").trim() === r2.value);
      if (r3.value) rows = rows.filter(r => String(r.region3||"").trim() === r3.value);
      if (rc.value) rows = rows.filter(r => String(r.complex_name||"").trim() === rc.value);

      // ✅ 단지별은 CSV에 있는 spc_bin(전용면적)별로 그대로 여러 행 표시됨
      render("complex", VIEW_COLS.complex, rows);

      if (badge) badge.textContent =
        `filter: ${[r1.value,r2.value,r3.value,rc.value].filter(Boolean).join(" / ") || "*"}`;
    };

    r1.onchange = ()=>{ refreshR2(); r3.value=""; rc.value=""; refreshR3(); refreshComplex(); apply(); };
    r2.onchange = ()=>{ refreshR3(); rc.value=""; refreshComplex(); apply(); };
    r3.onchange = ()=>{ refreshComplex(); apply(); };
    rc.onchange = apply;

    refreshR2();
    refreshR3();
    refreshComplex();
    apply();
  }

  async function loadAll(){
    setSubtitle(`${state.type} 데이터를 불러오는 중...`);

    // 차트 먼저
    await renderCharts();

    ["all","region","complex"].forEach(id => {
      hideWarn(id);
      const tb = document.getElementById(`tbody_${id}`);
      const th = document.getElementById(`thead_${id}`);
      const c  = document.getElementById(`cnt_${id}`);
      const m  = document.getElementById(`meta_${id}`);
      if (tb) tb.innerHTML = "<tr class='loading-row'><td colspan='100'>데이터 로딩 중...</td></tr>";
      if (th) th.innerHTML = "";
      if (c)  c.textContent = "rows: -";
      if (m)  m.textContent = "";
    });

    const results = await Promise.allSettled([
      loadOne("all"),
      loadOne("region"),
      loadOne("complex"),
    ]);

    const all    = (results[0].status==="fulfilled") ? results[0].value : {error:String(results[0].reason)};
    const region = (results[1].status==="fulfilled") ? results[1].value : {error:String(results[1].reason)};
    const complex= (results[2].status==="fulfilled") ? results[2].value : {error:String(results[2].reason)};

    VIEW_COLS.all     = (all.cols||[]).filter(c => !HIDE_COLS.all.has(c));
    VIEW_COLS.region  = (region.cols||[]).filter(c => !HIDE_COLS.region.has(c));
    VIEW_COLS.complex = (complex.cols||[]).filter(c => !HIDE_COLS.complex.has(c));

    const allRows     = (all.rows||[]).filter(passSpcBinRow);
    const regionRows  = (region.rows||[]).filter(passSpcBinRow);
    const complexRows = (complex.rows||[]).filter(passSpcBinRow);

    render("all", VIEW_COLS.all, allRows);
    render("region", VIEW_COLS.region, regionRows);
    render("complex", VIEW_COLS.complex, complexRows);

    initRegionFilters({ cols: region.cols||[], rows: regionRows });
    initComplexFilters({ cols: complex.cols||[], rows: complexRows });

    // 데이터 수정 (가능하면 latest CSV의 Last-Modified, KST YYYY-MM-DD 형식)
    const dataMTime = document.getElementById("dataMTime");
    if (dataMTime){
      const url = all.__url || (await pickFirstExisting(CANDIDATES[state.type].all));
      const lm = url ? await getLastModified(url) : null;
      if (lm) {
        const d = new Date(lm);
        const kst = new Date(d.getTime() + 9 * 60 * 60 * 1000);
        const yyyy = kst.getUTCFullYear();
        const mm = String(kst.getUTCMonth() + 1).padStart(2, "0");
        const dd = String(kst.getUTCDate()).padStart(2, "0");
        dataMTime.textContent = `데이터 수정 : ${yyyy}-${mm}-${dd}`;
      } else {
        dataMTime.textContent = `데이터 수정 : -`;
      }
    }

    const errors = [all, region, complex].filter(x => x && x.error).map(x => x.error);
    if (errors.length > 0) {
      setSubtitle(`일부 로딩 실패: ${errors.join(" | ")}`);
      if (all.error) showWarn("all", all.error);
      if (region.error) showWarn("region", region.error);
      if (complex.error) showWarn("complex", complex.error);
    } else {
      setSubtitle(`${state.type} · 모든 데이터가 정상적으로 표시됩니다.`);
    }
  }

  function setType(t){
    if (state.type === t) return;
    state.type = t;
    document.getElementById("pillA1").classList.toggle("on", t === "A1");
    document.getElementById("pillB1").classList.toggle("on", t === "B1");
    loadAll();
  }

  document.getElementById("pillA1").onclick = ()=> setType("A1");
  document.getElementById("pillB1").onclick = ()=> setType("B1");

  window.onload = loadAll;
</script>
</body>
</html>
