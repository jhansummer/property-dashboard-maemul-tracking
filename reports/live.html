<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>매물 트래킹 대시보드 (Live)</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --muted:#7f8ea3; --text:#e8eef7;
      --line:#24314a; --pill:#1a2640; --pillOn:#2a3a5f;
      --good:#66e3a6; --bad:#ff7b7b; --warn:#ffd166;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1400px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(11,15,23,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .topbar .wrap{padding:10px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-size:16px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .pills{display:flex;gap:8px}
    .pill{background:var(--pill);border:1px solid var(--line);padding:7px 12px;border-radius:999px;font-size:12px;cursor:pointer}
    .pill.on{background:var(--pillOn);font-weight:bold}
    .badge{font-size:11px;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#0f1626}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
    table{width:100%;border-collapse:separate;border-spacing:0}
    thead th{position:sticky;top:0;background:#1a2640;padding:10px;font-size:12px}
    tbody td{padding:10px;border-bottom:1px solid rgba(36,49,74,.55);font-size:12px}
    .num{text-align:right}
    .pct.good{color:var(--good);font-weight:700}
    .pct.bad{color:var(--bad);font-weight:700}
    select{background:#0f1626;border:1px solid var(--line);color:var(--text);padding:8px;border-radius:10px}
  </style>
</head>

<body>
<div class="topbar">
  <div class="wrap">
    <div class="row">
      <div>
        <div class="title">매물 트래킹 대시보드</div>
        <div class="sub" id="subtitle">로딩중…</div>
      </div>
      <div class="spacer"></div>
      <div class="pills">
        <div class="pill on" id="pillA1">A1 (매매)</div>
        <div class="pill" id="pillB1">B1 (전세)</div>
      </div>
      <span class="badge" id="lastLoaded">-</span>
    </div>
  </div>
</div>

<div class="wrap">
  <!-- 1 전체 -->
  <div class="card">
    <h3>1) 전체</h3>
    <table>
      <thead><tr id="thead_all"></tr></thead>
      <tbody id="tbody_all"></tbody>
    </table>
    <span class="badge" id="cnt_all"></span>
  </div>

  <!-- 2 지역 -->
  <div class="card">
    <h3>2) 지역별</h3>
    <select id="r2_1"></select>
    <select id="r2_2"></select>
    <select id="r2_3"></select>
    <table>
      <thead><tr id="thead_region"></tr></thead>
      <tbody id="tbody_region"></tbody>
    </table>
    <span class="badge" id="cnt_region"></span>
  </div>

  <!-- 3 단지 -->
  <div class="card">
    <h3>3) 단지별</h3>
    <select id="r3_1"></select>
    <select id="r3_2"></select>
    <select id="r3_3"></select>
    <select id="r3_c"></select>
    <table>
      <thead><tr id="thead_complex"></tr></thead>
      <tbody id="tbody_complex"></tbody>
    </table>
    <span class="badge" id="cnt_complex"></span>
  </div>
</div>

<script>
/* ===== 설정 ===== */
const DEFAULT_REGION = { r1:"서울시", r2:"강남구", r3:"" };
const HIDE_COLS = {
  all:new Set(["level","group"]),
  region:new Set(["level"]),
  complex:new Set(["level","hscpNo"])
};
const VIEW_COLS = { all:[], region:[], complex:[] };

const PATHS = {
  A1:{all:"./report_all_bins_A1_latest.csv",region:"./report_region_bins_A1_latest.csv",complex:"./report_complex_bins_A1_latest.csv"},
  B1:{all:"./report_all_bins_B1_latest.csv",region:"./report_region_bins_B1_latest.csv",complex:"./report_complex_bins_B1_latest.csv"}
};
let state={type:"A1"};

/* ===== 유틸 ===== */
const uniq=a=>[...new Set(a.filter(Boolean))].sort();
const toNum=v=>{if(!v)return null;v=String(v).replace('%','');const n=parseFloat(v);return isNaN(n)?null:n};
const pctClass=v=>v>0?"good":v<0?"bad":"";

/* ===== CSV ===== */
function parseCSV(t){
  if(!t)return{cols:[],rows:[]};
  if(t.charCodeAt(0)===0xFEFF)t=t.slice(1);
  const l=t.trim().split(/\r?\n/).map(r=>r.split(','));
  const cols=l.shift();
  return{cols,rows:l.map(r=>Object.fromEntries(cols.map((c,i)=>[c,r[i]||""])))};
}

/* ===== 렌더 ===== */
function render(sec,cols,rows){
  document.getElementById(`thead_${sec}`).innerHTML=cols.map(c=>`<th>${c}</th>`).join("");
  document.getElementById(`tbody_${sec}`).innerHTML=rows.map(r=>
    `<tr>${cols.map(c=>{
      const v=r[c]||"";
      const n=toNum(v);
      return `<td class="${n!=null?'num':''} ${v.includes('%')?`pct ${pctClass(n)}`:''}">${v}</td>`
    }).join("")}</tr>`
  ).join("");
  document.getElementById(`cnt_${sec}`).textContent=`rows: ${rows.length}`;
}

/* ===== 데이터 가공 ===== */
function transform(rows){
  return rows
    .filter(r=>!["<33",">=165"].includes(r.spc_bin))
    .map(r=>r.spc_bin==="ALL_BINS"?{...r,spc_bin:"전체"}:r);
}

/* ===== 로드 ===== */
async function loadOne(kind){
  const t=await fetch(PATHS[state.type][kind]+"?v="+Date.now()).then(r=>r.text());
  return parseCSV(t);
}

async function loadAll(){
  const all=await loadOne("all");
  const region=await loadOne("region");
  const complex=await loadOne("complex");

  const allRows=transform(all.rows);
  const regionRows=transform(region.rows);
  const complexRows=transform(complex.rows);

  VIEW_COLS.all=all.cols.filter(c=>!HIDE_COLS.all.has(c));
  VIEW_COLS.region=region.cols.filter(c=>!HIDE_COLS.region.has(c));
  VIEW_COLS.complex=complex.cols.filter(c=>!HIDE_COLS.complex.has(c));

  render("all",VIEW_COLS.all,allRows);
  render("region",VIEW_COLS.region,regionRows);
  render("complex",VIEW_COLS.complex,complexRows);

  initRegion(regionRows);
  initComplex(complexRows);

  document.getElementById("subtitle").textContent=`${state.type} 로드 완료`;
  document.getElementById("lastLoaded").textContent=new Date().toLocaleTimeString();
}

/* ===== 드롭다운 ===== */
function initRegion(rows){
  const r1=document.getElementById("r2_1"),r2=document.getElementById("r2_2"),r3=document.getElementById("r2_3");
  r1.innerHTML=`<option></option>`+uniq(rows.map(r=>r.region1)).map(v=>`<option>${v}</option>`).join("");
  r1.value=DEFAULT_REGION.r1;
  r2.innerHTML=uniq(rows.filter(r=>r.region1===r1.value).map(r=>r.region2)).map(v=>`<option>${v}</option>`).join("");
  r2.value=DEFAULT_REGION.r2;
  const apply=()=>render("region",VIEW_COLS.region,rows.filter(r=>(!r1.value||r.region1===r1.value)&&(!r2.value||r.region2===r2.value)));
  r1.onchange=r2.onchange=apply; apply();
}
function initComplex(rows){
  const r1=document.getElementById("r3_1"),r2=document.getElementById("r3_2"),r3=document.getElementById("r3_3"),rc=document.getElementById("r3_c");
  r1.innerHTML=`<option></option>`+uniq(rows.map(r=>r.region1)).map(v=>`<option>${v}</option>`).join("");
  r1.value=DEFAULT_REGION.r1;
  r2.innerHTML=uniq(rows.filter(r=>r.region1===r1.value).map(r=>r.region2)).map(v=>`<option>${v}</option>`).join("");
  r2.value=DEFAULT_REGION.r2;
  const apply=()=>render("complex",VIEW_COLS.complex,rows.filter(r=>(!r1.value||r.region1===r1.value)&&(!r2.value||r.region2===r2.value)));
  r1.onchange=r2.onchange=apply; apply();
}

/* ===== 토글 ===== */
document.getElementById("pillA1").onclick=()=>{state.type="A1";loadAll()};
document.getElementById("pillB1").onclick=()=>{state.type="B1";loadAll()};
window.onload=loadAll;
</script>
</body>
</html>
