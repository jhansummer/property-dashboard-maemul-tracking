<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>매물 트래킹 대시보드 (Latest)</title>
  <style>
    :root{
      --bg:#0b0f17; --card:#121a2a; --muted:#7f8ea3; --text:#e8eef7;
      --line:#24314a; --pill:#1a2640; --pillOn:#2a3a5f;
      --good:#66e3a6; --bad:#ff7b7b;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    .wrap{max-width:1400px;margin:0 auto;padding:14px}
    .topbar{position:sticky;top:0;z-index:50;background:rgba(11,15,23,.92);backdrop-filter:blur(10px);border-bottom:1px solid var(--line)}
    .topbar .wrap{padding:10px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .title{font-size:16px;font-weight:700}
    .sub{font-size:12px;color:var(--muted)}
    .spacer{flex:1}
    .pills{display:flex;gap:8px;flex-wrap:wrap}
    .pill{background:var(--pill);border:1px solid var(--line);color:var(--text);padding:7px 12px;border-radius:999px;font-size:12px;cursor:pointer;user-select:none}
    .pill.on{background:var(--pillOn);border-color:#3a4a70; font-weight: bold;}
    .badge{font-size:11px;color:#cfe0ff;border:1px solid var(--line);padding:4px 8px;border-radius:999px;background:#0f1626}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;margin-top:12px}
    .card h2{margin:0 0 10px 0;font-size:15px; color:#fff;}
    .hint{font-size:12px;color:var(--muted);margin-bottom:10px}
    .tableWrap{overflow:auto;border-radius:12px;border:1px solid var(--line);background:#0f1626}
    table{border-collapse:separate;border-spacing:0;width:100%; min-width:max-content;}
    thead th{position:sticky;top:0;background:#1a2640;color:#cfe0ff;font-size:12px;text-align:left;border-bottom:1px solid var(--line);padding:10px;white-space:nowrap}
    tbody td{padding:10px;border-bottom:1px solid rgba(36,49,74,.55);font-size:12px;color:var(--text);white-space:nowrap}
    tbody tr:hover td{background:rgba(138,180,255,.06)}
    .num{text-align:right; font-variant-numeric: tabular-nums;}
    .pct.good{color:var(--good);font-weight:700}
    .pct.bad{color:var(--bad);font-weight:700}
    .mini{font-size:11px;color:var(--muted);margin-top:8px}
    .loading-row td { text-align: center; padding: 40px; color: var(--muted); }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="wrap">
      <div class="row">
        <div>
          <div class="title">매물 트래킹 대시보드</div>
          <div class="sub" id="subtitle">데이터를 불러오는 중...</div>
        </div>
        <div class="spacer"></div>
        <div class="pills" aria-label="trade type">
          <div class="pill on" id="pillA1" onclick="setType('A1')">A1 (매매)</div>
          <div class="pill" id="pillB1" onclick="setType('B1')">B1 (전세)</div>
        </div>
        <span class="badge" id="lastLoaded">loaded: -</span>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div class="card">
      <h2>1) 전체 통계</h2>
      <div class="hint">• 면적 구간별 통합 데이터</div>
      <div class="tableWrap">
        <table>
          <thead><tr id="thead_all"></tr></thead>
          <tbody id="tbody_all"></tbody>
        </table>
      </div>
      <div class="mini" id="meta_all"></div>
      <span class="badge" id="cnt_all">rows: -</span>
    </div>

    <div class="card">
      <h2>2) 지역별 상세</h2>
      <div class="hint">• 지역(구/동) 및 면적 구간별 데이터 (가로 스크롤 가능)</div>
      <div class="tableWrap">
        <table>
          <thead><tr id="thead_region"></tr></thead>
          <tbody id="tbody_region"></tbody>
        </table>
      </div>
      <div class="mini" id="meta_region"></div>
      <span class="badge" id="cnt_region">rows: -</span>
    </div>

    <div class="card">
      <h2>3) 단지별 상세</h2>
      <div class="hint">• 주요 단지별 상세 데이터 (가로 스크롤 가능)</div>
      <div class="tableWrap">
        <table>
          <thead><tr id="thead_complex"></tr></thead>
          <tbody id="tbody_complex"></tbody>
        </table>
      </div>
      <div class="mini" id="meta_complex"></div>
      <span class="badge" id="cnt_complex">rows: -</span>
    </div>
  </div>

<script>
  const PATHS = {
    A1: {
      all:    "./report_all_bins_A1_latest.csv",
      region: "./report_region_bins_A1_latest.csv",
      complex:"./report_complex_bins_A1_latest.csv",
    },
    B1: {
      all:    "./report_all_bins_B1_latest.csv",
      region: "./report_region_bins_B1_latest.csv",
      complex:"./report_complex_bins_B1_latest.csv",
    }
  };

  let state = { type:"A1" };

  function splitCSVLine(line){
    const out=[]; let cur=""; let inQ=false;
    for (let i=0;i<line.length;i++){
      const ch=line[i];
      if (ch === '"'){
        if (inQ && line[i+1] === '"'){ cur+='"'; i++; }
        else inQ=!inQ;
      } else if (ch === ',' && !inQ){ out.push(cur); cur=""; }
      else cur+=ch;
    }
    out.push(cur); return out;
  }

  function parseCSV(text){
    // UTF-8 BOM 제거
    const cleanText = text.replace(/^\ufeff/, '');
    const lines = cleanText.replace(/\r/g,'').split('\n').filter(x => x.trim().length > 0);
    if (lines.length < 2) return {cols:[], rows:[]};

    const cols = splitCSVLine(lines[0]).map(s => s.trim());
    const rows = [];
    for (let i = 1; i < lines.length; i++){
      const parts = splitCSVLine(lines[i]);
      const obj = {};
      cols.forEach((c, idx) => {
        obj[c] = (parts[idx] !== undefined) ? parts[idx].trim() : "";
      });
      rows.push(obj);
    }
    return {cols, rows};
  }

  function toNum(x){
    if (x == null) return null;
    let s = String(x).trim(); 
    if (!s || s === "-") return null;
    if (s.endsWith('%')) s = s.replace('%','');
    const v = parseFloat(s);
    return Number.isFinite(v) ? v : null;
  }

  function pctClass(v){
    if (v == null) return "";
    if (v > 0) return "good";
    if (v < 0) return "bad";
    return "";
  }

  const NUM_COLS = new Set([
    "prev_cnt","curr_cnt","new_cnt","del_cnt",
    "prev_avg_eok","curr_avg_eok","new_avg_eok","del_avg_eok",
    "avg_change_pct","new_premium_pct","del_premium_pct"
  ]);

  function render(sectionId, cols, rows){
    const thead = document.getElementById(`thead_${sectionId}`);
    const tbody = document.getElementById(`tbody_${sectionId}`);
    const meta = document.getElementById(`meta_${sectionId}`);
    const cnt = document.getElementById(`cnt_${sectionId}`);

    thead.innerHTML = "";
    if (cols.length === 0) {
      tbody.innerHTML = "<tr><td colspan='100' style='text-align:center; padding:20px;'>데이터가 없습니다.</td></tr>";
      return;
    }

    cols.forEach(c => {
      const th = document.createElement("th");
      th.textContent = c;
      thead.appendChild(th);
    });

    tbody.innerHTML = "";
    rows.forEach(r => {
      const tr = document.createElement("tr");
      cols.forEach(c => {
        const td = document.createElement("td");
        const val = r[c] ?? "";
        if (NUM_COLS.has(c)) td.classList.add("num");
        if (String(val).includes('%')){
          td.classList.add("pct");
          td.classList.add(pctClass(toNum(val)));
        }
        td.textContent = val;
        tr.appendChild(td);
      });
      tbody.appendChild(tr);
    });

    cnt.textContent = `rows: ${rows.length}`;
    meta.textContent = `columns: ${cols.join(", ")}`;
  }

  async function loadOne(kind){
    const url = PATHS[state.type][kind] + `?v=${Date.now()}`;
    try {
      const res = await fetch(url);
      if (!res.ok) return {cols:[], rows:[], error: `${res.status}`};
      const text = await res.text();
      return parseCSV(text);
    } catch (e) {
      return {cols:[], rows:[], error: e.message};
    }
  }

  async function loadAll(){
    const subtitle = document.getElementById("subtitle");
    subtitle.textContent = `${state.type} 데이터를 불러오는 중...`;
    
    // 로딩 표시
    ["all", "region", "complex"].forEach(id => {
      document.getElementById(`tbody_${id}`).innerHTML = "<tr class='loading-row'><td colspan='100'>데이터 로딩 중...</td></tr>";
    });

    const [all, region, complex] = await Promise.all([
      loadOne("all"),
      loadOne("region"),
      loadOne("complex"),
    ]);

    render("all", all.cols, all.rows);
    render("region", region.cols, region.rows);
    render("complex", complex.cols, complex.rows);

    const errors = [all, region, complex].filter(x => x.error).map(x => x.error);
    if (errors.length > 0) {
      subtitle.textContent = `일부 로딩 실패: ${errors.join(", ")}`;
    } else {
      document.getElementById("lastLoaded").textContent = `loaded: ${new Date().toLocaleTimeString()}`;
      subtitle.textContent = `${state.type} · 모든 데이터가 정상적으로 표시됩니다.`;
    }
  }

  function setType(t){
    if (state.type === t) return;
    state.type = t;
    document.getElementById("pillA1").classList.toggle("on", t === "A1");
    document.getElementById("pillB1").classList.toggle("on", t === "B1");
    loadAll();
  }

  // 초기 실행
  window.onload = loadAll;
</script>
</body>
</html>
